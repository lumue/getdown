<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="redux-store.html">
<link rel="import" href="url-input.html">

<dom-module id="task-list">
	<template>
		<style include="shared-styles">
			:host {
				display: block;

				padding: 10px;
			}

			.toolbar{
				display: flex;
				flex-direction: row-reverse
			}

			vaadin-dialog[part="content"] {
				width: 800px;
			}

		</style>

		<vaadin-dialog id="addUrlDialog">
			<template>
				<url-input></url-input>
			</template>
		</vaadin-dialog>

		<div class="toolbar">
			<paper-icon-button icon="add" on-tap="_handleAdd" ></paper-icon-button>
			<paper-icon-button icon="delete" on-tap="_handleDelete" hidden$="[[hideDeleteButton]]"></paper-icon-button>
			<paper-icon-button icon="file-download" on-tap="_handleDownload" hidden$="[[hideDownloadButton]]"></paper-icon-button>
		</div>

		<vaadin-grid id="grid" items="[[tasks]]" on-selected-items-changed="_selectedItemsChanged" size="20">
			<vaadin-grid-selection-column auto-select>
			</vaadin-grid-selection-column>
			<vaadin-grid-column>
				<template class="header">
					<vaadin-grid-sorter path="sourceUrl">Url</vaadin-grid-sorter>
				</template>
				<template>[[item.sourceUrl]]</template>
			</vaadin-grid-column>
			<vaadin-grid-column>
				<template class="header">
					<vaadin-grid-sorter path="name">Name</vaadin-grid-sorter>
				</template>
				<template>[[item.name]]</template>
			</vaadin-grid-column>
			<vaadin-grid-column>
				<template class="header">
					<vaadin-grid-sorter path="expectedSize">Size</vaadin-grid-sorter>
				</template>
				<template>[[item.expectedSize]]</template>
			</vaadin-grid-column>
			<vaadin-grid-column>
				<template class="header"><vaadin-grid-sorter path="state">State</vaadin-grid-sorter></template>
				<template>[[item.state]]</template>
			</vaadin-grid-column>
		</vaadin-grid>

	</template>


	<script>
		class TaskList extends GetdownConsole.ReduxMixin(Polymer.Element) {

			static get is() {
				return 'task-list';
			}

			static get properties() {
				return {
					tasks:{
						type: Array,
						statePath: 'tasksReducer.tasks'
					},
					hideDeleteButton:{
						type: Boolean,
						computed: 'isSelectionEmpty(_selectedItems)',
						notify: true,
						reflectToAttribute: true
					},
					hideDownloadButton:{
						type: Boolean,
						computed: 'isSelectionEmpty(_selectedItems)',
						notify: true,
						reflectToAttribute: true
					},
					_selectedItems:{
						type:Array,
						statePath: 'tasksReducer.selectedTasks'
					}

				}
			}

			_selectedItemsChanged(event){
				
				console.log('selection changed')
				var added=[],removed=[]

				if(!event.detail.path){
					if(event.detail.value.length===0)
						this.dispatch('unselectAllTasks',event.detail.value)
					else
						this.dispatch('selectAllTasks',event.detail.value)

					return
				}



				if("selectedItems.splices" === event.detail.path &&event.detail.value.indexSplices){
					
					const indexSplices=event.detail.value.indexSplices
					

					for(let i=0;i<indexSplices.length;i++){
						const changes=event.detail.value.indexSplices[i]
						added=added.concat(changes.object)
						removed=removed.concat(changes.removed)
					}

					if(added.length>0)
						this.dispatch('selectTasks',added)
					
					if(removed.length>0)
						this.dispatch('unselectTasks',removed)
				}
			}


			connectedCallback(){
				super.connectedCallback()
				this.dispatch('fetchTasks')
			}

			_handleDelete(){
				this.dispatch('removeTasks',this._selectedItems)
			}

			_handleDownload(){
				this.dispatch('addJob',this._selectedItems)
			}

			_handleAdd(){
				this.$.addUrlDialog.opened=true;
			}

			isSelectionEmpty(items){
				return !items
						||
						(!items.length>0)
			}
		}

		window.customElements.define(TaskList.is, TaskList);
	</script>
</dom-module>
