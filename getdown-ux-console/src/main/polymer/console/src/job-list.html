<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/vaadin-progress-bar/vaadin-progress-bar.html">
<link rel="import" href="../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="redux-store.html">

<dom-module id="job-list">
	<template>
		<style is="custom-style">
			:host {
				display: block;

				padding: 10px;
				--material-body-font-size: 11px;

			}

			.toolbar {
				display: flex;
				flex-direction: row-reverse
			}


		</style>

		<div class="toolbar" style="min-height:40px;">
			<paper-icon-button icon="cancel" on-tap="_handleCancelTap" hidden$="[[_hideCancel]]"></paper-icon-button>
			<paper-icon-button icon="refresh" on-tap="_handleRestartTap" hidden$="[[_hideRefresh]]"></paper-icon-button>
			<paper-icon-button icon="delete" on-tap="_handleDeleteTap" hidden$="[[_hideDelete]]"></paper-icon-button>
		</div>


		<vaadin-grid id="grid" items="[[jobs]]" on-selected-items-changed="_selectedItemsChanged" size="40">
			<vaadin-grid-selection-column auto-select>
			</vaadin-grid-selection-column>
			<vaadin-grid-column resizable>
				<template class="header">
					<vaadin-grid-sorter path="name">Name</vaadin-grid-sorter>
				</template>
				<template>[[item.name]]</template>
			</vaadin-grid-column>
			<vaadin-grid-column>
				<template class="header">
					<vaadin-grid-sorter path="state">State</vaadin-grid-sorter>
				</template>
				<template>[[item.state]]</template>
			</vaadin-grid-column>
			<vaadin-grid-column>
				<template class="header">Progress</template>
				<template>
					<span>[[_percentage(item.downloadProgress.size,item.downloadProgress.downloadedSize)]]%</span>
					<vaadin-progress-bar style="width: 100%"
					                     value="[[item.downloadProgress.downloadedSize]]"
					                     max="[[item.downloadProgress.size]]"
					                     min="0"
					                     id="paper_progress">
					</vaadin-progress-bar>
				</template>
			</vaadin-grid-column>
			<vaadin-grid-column resizable>
				<template class="header">Last message</template>
				<template>[[item.message]]</template>
			</vaadin-grid-column>
		</vaadin-grid>

	</template>


	<script>
		class JobList extends GetdownConsole.ReduxMixin(Polymer.Element) {

			static get is() {
				return 'job-list';
			}

			static get properties() {
				return {
					jobs: {
						type: Array,
						statePath: 'jobsReducer.jobs'
					},
					_hideCancel: {
						type: Boolean,
						computed: 'isSelectionEmpty(_selectedItems)',
						notify: true,
						reflectToAttribute: true
					},
					_hideRefresh: {
						type: Boolean,
						computed: 'isSelectionEmpty(_selectedItems)',
						notify: true,
						reflectToAttribute: true
					},
					_hideDelete: {
						type: Boolean,
						computed: 'isSelectionEmpty(_selectedItems)',
						notify: true,
						reflectToAttribute: true
					},
					_selectedItems: {
						type: Array,
						statePath: 'jobsReducer.selectedJobs'
					}
				}
			}

			connectedCallback() {
				super.connectedCallback()
				this.dispatch('fetchJobs')
			}

			_percentage(gw, pw) {
				return Math.round(((pw / gw) * 100) * 100) / 100
			}

			isSelectionEmpty(items) {
				return !items
						||
						(!items.length > 0)
			}

			_selectedItemsChanged(event) {

				console.log('selection changed')
				var added = [], removed = []

				if (!event.detail.path) {
					if (event.detail.value.length === 0)
						this.dispatch('unselectAllJobs', event.detail.value)
					else
						this.dispatch('selectAllJobs', event.detail.value)

					return
				}


				if ("selectedItems.splices" === event.detail.path && event.detail.value.indexSplices) {

					const indexSplices = event.detail.value.indexSplices


					for (let i = 0; i < indexSplices.length; i++) {
						const changes = event.detail.value.indexSplices[i]
						added = added.concat(changes.object)
						removed = removed.concat(changes.removed)
					}

					if (added.length > 0)
						this.dispatch('selectJobs', added)

					if (removed.length > 0)
						this.dispatch('unselectJobs', removed)
				}
			}


		}

		window.customElements.define(JobList.is, JobList);
	</script>
</dom-module>
